language: python
sudo: false
python:
    - "2.7"
env:
  global:
    - secure: "XcCnjadKiF2pCrunhlvwjwiXQ/uz7Y0xPzwGQ+/YqwH/ZVEZWaWJb0JzdJEUM6baOAsg9tZg5zyqjX6u8mMgc0GpqiQXbsJv/n8ilXtUWWs+eA2MOx+9yFpRdBpc6SZKcMZtLS+eV6hN9lDN5tZ/BItZ1iFiJvPa9Zr2/Kpgu5KiFjOF8WZxosu/RnaLj6USiHERKoJHWgYZ1fMr0ZvCBGlBVDxmD5q9uXilJ34cCXxv1tGTH6JzFJM10sVJi4kEmuTO1OgsGejPS29mmTdlHkgpGWzyZZRF1DRnNnr/wD8zwp9Ih242w+2GvH/wxdzW3LXr3kJzs3ta0qfUpaGZoBqKXuDVu4NE3dK7qctbl2cLoxHb2TH2vA219TM7N8A21qltCre65d398ul+stM7+Z14jD8cjloaojK//OEyDqw7d6pkgjgzWhWlQvaG+m5jLoCL/ab9PG1iliIc7jUuw2r6M7TBfVqYa0xJwiP205i81WD1pMg/jBbk71nYOe95jdJYnFszLPmzZ2OU345WuUoN8FZ7pUNTPhjE09W+HgRHjJC4wOb44uKyPLZtruzL51mi+4G1rGf/wfPevCT3/wMzUpq8bPDTl4BBd6NfOSs5ddQ2ddVFeROGVJapTkzPiNMr3K85AkFj2WzEFMEOwJnSx4FD+iSBdApGhZmdXU8=" # FEC_CF_USERNAME
    - secure: "pmsRV6macodCei0maFf1E3Tf98a0Jmyvt8CV1gM1G8VBWW3oqQmnTRKJUak9MK+coNbmEQHub7jbtg1JMKi8GdeaWn0qpIz/jxuzzGaYkn4X6jqRzSC7BouTX5xHJQZb5ch6u2Bgqhes2ULbD/Ivp6yPhl78FypG/NTyLMYhs5c9rZn8UQcee9Wjb5dH1gqKS8GXJArHiH2B2fee75OFqGmq32+qJVDc3JlTpRik491n/lt4xTcImt2AyOJW5lA00fEqxmjY4LJXhic8rrvppqGPJb9mhmSscTiK2yfk9IuVGiBBYFoNHAXWH8lFyGrAUXBwseiWLR9s9nPf0sebqFF/Xa7wNV1CtLC1HUbdb+RIInUiFxzZKc9uCj4yhn7gi8FvwQQtCaEAhK2+KUtJYS70FUrs+WIiqCPVTLkVAnLqZawG+SP1chJPD5S196UY85CeJnWCFbuEMp1wj8JW8ACE8Qf9a2pb4tJyD8zwIqMdQYN+XITSLDiSrhlRcnHJc/yMH6RNqAqvpthxAgXYVTya9uOc86lLXwh4U6HbASfUAj6bfArJrwNM8hEvWqHT0EPfZ+6E02xui90eyUEIMImHUD6HeV0sc6IfMOuOMdtibO7Do+Ykupm1YIqlXy4kAJ28d7eqW4mvi8NBEMWQGUvpjEfJfIJFCVXuRbpmwaM=" # FEC_CF_PASSWORD

before_install:
  - gem install sass

install:
    - pip install -r requirements.txt
    - pip install -r requirements_test.txt
    - pip install -r requirements_dev.txt
    - npm install -g grunt-cli bower
    - npm install
script:
    - npm run build
    - python manage.py migrate --fake-initial
    - python manage.py compile_frontend
    - python manage.py test

before_deploy:
  - mkdir $HOME/bin
  - export PATH=$HOME/bin:$PATH
  - travis_retry curl -L "https://cli.run.pivotal.io/stable?release=linux64-binary&version=6.15.0" | tar xzv -C $HOME/bin
  - travis_retry cf install-plugin autopilot -f -r CF-Community

# Simple smoke tests
after_deploy:
  - curl --silent --fail --head https://fec-dev-eregs.18f.gov/regulations || travis_terminate $?
  - curl --silent --fail --get https://fec-dev-eregs.18f.gov/regulations/api/regulation/2 > /dev/null || travis_terminate $?

deploy:
  - provider: script
    skip_cleanup: true
    script: ./bin/cf_deploy.sh eregs fec dev manifest.dev.yml
    on:
      branch: develop

  - provider: script
    skip_cleanup: true
    script: ./bin/cf_deploy.sh eregs fec stage manifest.stage.yml
    on:
      branch: release/*

  - provider: script
    skip_cleanup: true
    script: ./bin/cf_deploy.sh eregs fec prod manifest.prod.yml
    on:
      tags: true
